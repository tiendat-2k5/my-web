<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-capable" content="yes"> <title>Kens Control Hub</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- 1. C·∫§U H√åNH C·ªêT L√ïI (CH·ªêNG CU·ªòN) --- */
        body { 
            margin: 0; padding: 10px; 
            background: #000; color: white; 
            font-family: 'Segoe UI', sans-serif; 
            height: 100vh; width: 100vw; /* √âp c·ª©ng chi·ªÅu cao/r·ªông b·∫±ng m√†n h√¨nh */
            box-sizing: border-box; 
            overflow: hidden; /* C·∫•m tuy·ªát ƒë·ªëi thanh cu·ªôn */
        }

        /* --- 2. GRID LAYOUT TH√îNG MINH --- */
        .dashboard-grid {
            display: grid;
            height: 100%; width: 100%;
            gap: 10px;
            /* M·∫∑c ƒë·ªãnh cho ƒëi·ªán tho·∫°i D·ªåC (Portrait) */
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 2.5fr 1.5fr 1.5fr 1.2fr; /* Chia t·ªâ l·ªá chi·ªÅu cao c√°c h√†ng */
            grid-template-areas: 
                "clock clock"
                "weather status"
                "lamp calendar"
                "music music";
        }

        /* T√πy ch·ªânh cho ƒëi·ªán tho·∫°i NGANG (Landscape) */
        @media (orientation: landscape) {
            .dashboard-grid {
                grid-template-columns: 1.5fr 1fr 1fr; /* C·ªôt ƒë·∫ßu to h∆°n */
                grid-template-rows: 1fr 1fr; /* 2 h√†ng ƒë·ªÅu nhau */
                grid-template-areas: 
                    "clock weather status"
                    "music lamp calendar";
            }
        }

        /* --- 3. THI·∫æT K·∫æ WIDGET --- */
        .widget {
            background: #1e1e1e;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: background 0.2s;
        }
        .widget:active { transform: scale(0.98); opacity: 0.9; }

        /* G√°n widget v√†o v√πng Grid ƒë√£ ƒë·ªãnh nghƒ©a */
        .area-clock { grid-area: clock; background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); }
        .area-weather { grid-area: weather; background: #263238; }
        .area-status { grid-area: status; background: #212121; border: 1px solid #333; }
        .area-lamp { grid-area: lamp; background: #FFC107; color: #000; }
        .area-calendar { grid-area: calendar; background: #FF5722; }
        .area-music { grid-area: music; background: #000; border: 1px solid #333; padding: 0; overflow: hidden; }

        /* Font ch·ªØ co gi√£n theo m√†n h√¨nh (Viewport Units) */
        #clock { font-size: 12vh; font-weight: bold; line-height: 1; } /* Gi·ªù to theo chi·ªÅu cao m√†n h√¨nh */
        #date { font-size: 2.5vh; margin-top: 5px; opacity: 0.8; }
        .widget-icon { font-size: 8vh; margin-bottom: 5px; }
        .widget-label { font-size: 2vh; font-weight: bold; text-transform: uppercase; }
        .widget-sub { font-size: 1.8vh; opacity: 0.7; }

        /* Ri√™ng cho Landscape th√¨ gi·∫£m font ƒë·ªìng h·ªì ch√∫t cho ƒë·ª° v·ª° */
        @media (orientation: landscape) {
            #clock { font-size: 15vh; }
            .widget-icon { font-size: 10vh; }
        }

        /* --- 4. MODAL (POPUP) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: #222; width: 85%; max-width: 400px;
            padding: 20px; border-radius: 20px; text-align: center;
            border: 1px solid #444;
        }
        .lamp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .lamp-btn {
            padding: 20px; border: none; border-radius: 15px;
            font-size: 18px; font-weight: bold; color: white;
        }
        .close-btn { 
            position: absolute; top: 20px; right: 20px; 
            font-size: 30px; color: #fff; cursor: pointer; z-index: 1001;
        }

    </style>
</head>
<body>

    <div class="dashboard-grid">
        
        <div class="widget area-clock">
            <div id="clock">00:00</div>
            <div id="date">ƒêang t·∫£i...</div>
        </div>

        <div class="widget area-weather">
            <span id="weather-icon" class="widget-icon">üå§Ô∏è</span>
            <div id="temperature" style="font-size: 4vh; font-weight: bold;">--¬∞C</div>
            <div id="weather-desc" class="widget-sub">TP.HCM</div>
        </div>

        <div class="widget area-status">
            <span class="material-icons widget-icon" style="color: #4CAF50;">bluetooth</span>
            <div class="widget-sub">TR·∫†NG TH√ÅI</div>
            <div id="lamp-status-text" style="font-weight: bold; color: #4CAF50; font-size: 2vh;">S·∫µn s√†ng</div>
        </div>

        <div class="widget area-lamp" onclick="openModal('modal-lamp')">
            <span class="material-icons widget-icon">lightbulb</span>
            <div class="widget-label">ƒêI·ªÄU KHI·ªÇN</div>
        </div>

        <div class="widget area-calendar" onclick="openModal('modal-calendar')">
            <span class="material-icons widget-icon">event</span>
            <div class="widget-label">L·ªäCH</div>
        </div>

        <div class="widget area-music">
            <iframe width="100%" height="100%" 
                    src="https://www.youtube.com/embed/videoseries?list=PLmP7O47PTy-McItNVWpEZxPTzqByUso82&si=tWm8Dz5hA25gRQ9X&autoplay=0&loop=1&controls=1" 
                    title="YouTube Music" frameborder="0" allow="autoplay; encrypted-media"></iframe>
        </div>
    </div>


    <div id="modal-lamp" class="modal-overlay">
        <span class="close-btn" onclick="closeModal('modal-lamp')">&times;</span>
        <div class="modal-content">
            <h2 style="margin: 0 0 15px 0; color: #FFC107;">üí° ƒêI·ªÄU KHI·ªÇN</h2>
            
            <button onclick="initBluetooth()" style="width: 100%; padding: 15px; background: #2196F3; border: none; border-radius: 10px; color: white; font-weight: bold; margin-bottom: 10px;">
                üîó K·∫æT N·ªêI BLUETOOTH
            </button>
            <div id="bt-log" style="font-size: 12px; color: #aaa; margin-bottom: 15px;">Ch∆∞a k·∫øt n·ªëi</div>

            <div class="lamp-grid">
                <button class="lamp-btn" style="background: #4CAF50;" onclick="sendHex('ON')">B·∫¨T</button>
                <button class="lamp-btn" style="background: #f44336;" onclick="sendHex('OFF')">T·∫ÆT</button>
                <button class="lamp-btn" style="background: #9C27B0;" onclick="sendHex('STUDY')">üìñ H·ªåC</button>
                <button class="lamp-btn" style="background: #E91E63;" onclick="sendHex('RELAX')">üéÆ CH∆†I</button>
            </div>
        </div>
    </div>

    <div id="modal-calendar" class="modal-overlay">
        <span class="close-btn" onclick="closeModal('modal-calendar')">&times;</span>
        <div class="modal-content" style="width: 90%; height: 80%; max-width: none;">
            <iframe src="https://calendar.google.com/calendar/embed?src=tiendatphannguyen@gmail.com&ctz=Asia%2FHo_Chi_Minh&mode=AGENDA" 
                    style="border: 0; width: 100%; height: 100%; border-radius: 10px;" frameborder="0"></iframe>
        </div>
    </div>

    <script>
        /* --- LOGIC ƒê·ªíNG H·ªí --- */
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('date').innerText = now.toLocaleDateString('vi-VN', { weekday: 'long', day: 'numeric', month: 'numeric' });
        }
        setInterval(updateClock, 1000); updateClock();

        /* --- LOGIC TH·ªúI TI·∫æT --- */
        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=10.8231&longitude=106.6297&current_weather=true');
                const data = await res.json();
                document.getElementById('temperature').innerText = Math.round(data.current_weather.temperature) + "¬∞C";
                const code = data.current_weather.weathercode;
                document.getElementById('weather-icon').innerText = code > 50 ? "üåßÔ∏è" : (code > 3 ? "‚òÅÔ∏è" : "‚òÄÔ∏è");
                document.getElementById('weather-desc').innerText = code > 50 ? "M∆∞a" : (code > 3 ? "M√¢y" : "N·∫Øng");
            } catch (e) {}
        }
        fetchWeather(); setInterval(fetchWeather, 1800000);

        /* --- LOGIC MODAL --- */
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        /* --- LOGIC BLUETOOTH (CORE) --- */
        let lampCharacteristic = null;
        const SERVICE_UUID = '0000fff0-0000-1000-8000-00805f9b34fb'; 
        const CHAR_UUID    = '0000fff3-0000-1000-8000-00805f9b34fb'; 
        const HEX_CODES = {
            'ON':    [0x7E, 0x04, 0x04, 0xF0, 0x00, 0x01, 0xFF, 0x00, 0xEF], 
            'OFF':   [0x7E, 0x04, 0x04, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xEF], 
            'STUDY': [0x7E, 0x05, 0x03, 0x00, 0xFF, 0x00],
            'RELAX': [0x7E, 0x05, 0x03, 0xFF, 0x00, 0xFF]  
        };

        async function initBluetooth() {
            const log = document.getElementById('bt-log');
            const statusText = document.getElementById('lamp-status-text');
            try {
                log.innerText = "ƒêang qu√©t...";
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID.toLowerCase()]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID.toLowerCase());
                lampCharacteristic = await service.getCharacteristic(CHAR_UUID.toLowerCase());
                
                log.innerText = "ƒê√£ k·∫øt n·ªëi: " + device.name;
                statusText.innerText = "ƒê√£ k·∫øt n·ªëi";
                statusText.style.color = "#00ff00";

                device.addEventListener('gattserverdisconnected', () => {
                    statusText.innerText = "M·∫•t k·∫øt n·ªëi";
                    statusText.style.color = "red";
                    log.innerText = "ƒê√£ ng·∫Øt k·∫øt n·ªëi";
                });
            } catch (err) {
                log.innerText = "L·ªói: " + err.message;
            }
        }

        async function sendHex(mode) {
            if (!lampCharacteristic) return alert("Ch∆∞a k·∫øt n·ªëi Bluetooth!");
            const cmd = new Uint8Array(HEX_CODES[mode]);
            try { await lampCharacteristic.writeValueWithResponse(cmd); } 
            catch (e) { await lampCharacteristic.writeValueWithoutResponse(cmd); }
        }
    </script>
</body>
</html>
