<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kens Control Hub</title>
    <style>
        body { margin: 0; padding: 0; background: #111; color: white; font-family: sans-serif; height: 100vh; overflow: hidden; }
        
        /* Khu v·ª±c hi·ªÉn th·ªã n·ªôi dung */
        .content-area { height: calc(100vh - 70px); overflow-y: auto; padding: 15px; }
        .tab-content { display: none; }
        .active { display: block; }
        
        /* Thanh Tab Bar b√™n d∆∞·ªõi */
        .tab-bar { height: 70px; background: #222; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; }
        .tab-item { text-align: center; color: #888; cursor: pointer; font-size: 12px; }
        .tab-item.active-tab { color: #00ff00; }
        
        /* N√∫t b·∫•m hi·ªáu ·ª©ng */
        button:active { transform: scale(0.95); opacity: 0.8; }
    </style>
</head>
<body>

    <div class="content-area">
        <div id="home" class="tab-content active">
            <div id="clock" style="font-size: 45px; text-align: center; margin-top: 30px; font-weight: bold; letter-spacing: 2px;">00:00</div>
            <div id="date" style="text-align: center; color: #888; font-size: 14px; margin-bottom: 10px;">Th·ª©..., ng√†y...</div>
            
            <div id="weather-box" style="text-align: center; background: #222; padding: 15px; margin: 10px 20px; border-radius: 15px; display: flex; justify-content: center; align-items: center; gap: 15px;">
                <span id="weather-icon" style="font-size: 30px;">üå§Ô∏è</span>
                <div>
                    <div id="temperature" style="font-size: 24px; font-weight: bold;">--¬∞C</div>
                    <div id="weather-desc" style="font-size: 12px; color: #aaa;">ƒêang t·∫£i...</div>
                </div>
            </div>

            <div style="height: 350px; margin-top: 20px; border-radius: 15px; overflow: hidden; border: 1px solid #333;">
                <iframe src="https://calendar.google.com/calendar/embed?src=tiendatphannguyen@gmail.com&ctz=Asia%2FHo_Chi_Minh&mode=MONTH&showTitle=0&showNav=0&showDate=0&showPrint=0&showTabs=0&showCalendars=0&showTz=0&bgcolor=%230d1117" 
                        style="border: 0; width: 100%; height: 100%;" frameborder="0" scrolling="no"></iframe>
            </div>
        </div>

        <div id="control" class="tab-content">
            <h3 style="text-align: center; margin-bottom: 20px; color: #00ff00;">üí° ƒê√®n Neon B√†n H·ªçc</h3>
            
            <button onclick="initBluetooth()" id="connect-btn" style="width: 100%; padding: 15px; background: #008CBA; border: none; border-radius: 10px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                üîó K·∫æT N·ªêI BLUETOOTH
            </button>
            
            <p id="status" style="text-align: center; color: #ffd700; margin: 15px 0; font-size: 13px; font-style: italic;">S·∫µn s√†ng k·∫øt n·ªëi...</p>
            
            <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                <button onclick="sendHex('ON')" style="width: 48%; padding: 25px; background: #4CAF50; border: none; border-radius: 15px; color: white; font-weight: bold; font-size: 20px;">B·∫¨T</button>
                <button onclick="sendHex('OFF')" style="width: 48%; padding: 25px; background: #f44336; border: none; border-radius: 15px; color: white; font-weight: bold; font-size: 20px;">T·∫ÆT</button>
            </div>

             <div style="display: flex; justify-content: space-around; margin-top: 25px;">
                <button onclick="sendHex('STUDY')" style="background: #2196F3; color: white; border: none; padding: 12px 25px; border-radius: 25px; font-weight: bold;">üìñ H·ªçc t·∫≠p</button>
                <button onclick="sendHex('RELAX')" style="background: #9C27B0; color: white; border: none; padding: 12px 25px; border-radius: 25px; font-weight: bold;">üéÆ Gi·∫£i tr√≠</button>
            </div>

            <div style="margin-top: 30px; background: #222; padding: 10px; border-radius: 15px; border: 1px solid #444;">
                <p style="margin: 0 0 10px 10px; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Music Player</p>
                <iframe width="100%" height="80" 
                        src="https://www.youtube.com/embed/videoseries?list=PLmP7O47PTy-McItNVWpEZxPTzqByUso82&si=tWm8Dz5hA25gRQ9X&autoplay=0&loop=1" 
                        title="YouTube Music Player" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                </iframe>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active-tab" onclick="switchTab('home', this)">
            <span style="font-size: 22px;">üè†</span>Home
        </div>
        <div class="tab-item" onclick="switchTab('control', this)">
            <span style="font-size: 22px;">‚öôÔ∏è</span>Control
        </div>
    </div>

    <script>
        /* --- 1. GIAO DI·ªÜN & ƒê·ªíNG H·ªí --- */
        function switchTab(tabId, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active-tab'));
            document.getElementById(tabId).classList.add('active');
            el.classList.add('active-tab');
        }

        function updateClock() {
            const now = new Date();
            // C·∫≠p nh·∫≠t gi·ªù ph√∫t
            document.getElementById('clock').innerText = now.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
            // C·∫≠p nh·∫≠t ng√†y th√°ng
            const options = { weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric' };
            document.getElementById('date').innerText = now.toLocaleDateString('vi-VN', options);
        }
        setInterval(updateClock, 1000);
        updateClock();

        /* --- 2. TH·ªúI TI·∫æT (M·ªöI TH√äM) --- */
        async function fetchWeather() {
            try {
                // T·ªça ƒë·ªô TP.HCM: 10.82, 106.63
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=10.8231&longitude=106.6297&current_weather=true');
                const data = await response.json();
                
                const temp = data.current_weather.temperature;
                const code = data.current_weather.weathercode;
                
                // C·∫≠p nh·∫≠t nhi·ªát ƒë·ªô
                document.getElementById('temperature').innerText = temp + "¬∞C";

                // Di·ªÖn gi·∫£i m√£ th·ªùi ti·∫øt
                let icon = "üå§Ô∏è";
                let desc = "Tr·ªùi quang";
                
                if (code <= 3) { icon = "‚òÅÔ∏è"; desc = "C√≥ m√¢y"; }
                if (code >= 51 && code <= 67) { icon = "üåßÔ∏è"; desc = "M∆∞a nh·ªè"; }
                if (code >= 80 && code <= 99) { icon = "‚õàÔ∏è"; desc = "M∆∞a r√†o/D√¥ng"; }
                
                document.getElementById('weather-icon').innerText = icon;
                document.getElementById('weather-desc').innerText = desc;

            } catch (error) {
                console.log("L·ªói t·∫£i th·ªùi ti·∫øt:", error);
                document.getElementById('weather-desc').innerText = "L·ªói m·∫°ng";
            }
        }
        // G·ªçi h√†m th·ªùi ti·∫øt ngay khi m·ªü web v√† c·∫≠p nh·∫≠t m·ªói 30 ph√∫t
        fetchWeather();
        setInterval(fetchWeather, 1800000);

        /* --- 3. BLUETOOTH CONTROL --- */
        let lampCharacteristic = null;
        const SERVICE_UUID = '0000fff0-0000-1000-8000-00805f9b34fb'; 
        const CHAR_UUID    = '0000fff3-0000-1000-8000-00805f9b34fb'; 

        const HEX_CODES = {
            'ON':    [0x7E, 0x04, 0x04, 0xF0, 0x00, 0x01, 0xFF, 0x00, 0xEF], 
            'OFF':   [0x7E, 0x04, 0x04, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xEF], 
            'STUDY': [0x7E, 0x05, 0x03, 0x00, 0xFF, 0x00],
            'RELAX': [0x7E, 0x05, 0x03, 0xFF, 0x00, 0xFF]  
        };

        async function initBluetooth() {
            const statusEl = document.getElementById('status');
            try {
                statusEl.innerText = "ƒêang qu√©t thi·∫øt b·ªã...";
                statusEl.style.color = "yellow";
                
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID.toLowerCase()] 
                });

                statusEl.innerText = "K·∫øt n·ªëi: " + device.name;
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID.toLowerCase());
                lampCharacteristic = await service.getCharacteristic(CHAR_UUID.toLowerCase());

                statusEl.innerText = "‚úÖ ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng!";
                statusEl.style.color = "#00ff00";
                
                // T·ª± ƒë·ªông ng·∫Øt k·∫øt n·ªëi khi thi·∫øt b·ªã m·∫•t s√≥ng
                device.addEventListener('gattserverdisconnected', () => {
                    statusEl.innerText = "‚ö†Ô∏è M·∫•t k·∫øt n·ªëi!";
                    statusEl.style.color = "red";
                    lampCharacteristic = null;
                });

            } catch (error) {
                statusEl.innerText = "‚ùå L·ªói: " + error.message;
                statusEl.style.color = "red";
            }
        }

        async function sendHex(mode) {
            const statusEl = document.getElementById('status');
            if (!lampCharacteristic) {
                statusEl.innerText = "‚ö†Ô∏è Ch∆∞a k·∫øt n·ªëi Bluetooth!";
                statusEl.style.color = "orange";
                return;
            }
            const command = new Uint8Array(HEX_CODES[mode]);
            try {
                await lampCharacteristic.writeValueWithResponse(command);
                statusEl.innerText = "‚úÖ ƒê√£ g·ª≠i l·ªánh: " + mode;
            } catch (error) {
                try {
                    await lampCharacteristic.writeValueWithoutResponse(command);
                    statusEl.innerText = "‚úÖ ƒê√£ g·ª≠i (No-Resp): " + mode;
                } catch (err2) {
                    statusEl.innerText = "‚ùå L·ªói g·ª≠i: " + err2.message;
                }
            }
        }
    </script>
</body>
</html>
