<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kens Control Hub</title>
    <style>
        body { margin: 0; padding: 0; background: #111; color: white; font-family: sans-serif; height: 100vh; overflow: hidden; }
        
        /* Khu v·ª±c hi·ªÉn th·ªã n·ªôi dung */
        .content-area { height: calc(100vh - 70px); overflow-y: auto; padding: 15px; }
        .tab-content { display: none; }
        .active { display: block; }
        
        /* Thanh Tab Bar b√™n d∆∞·ªõi */
        .tab-bar { height: 70px; background: #222; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; }
        .tab-item { text-align: center; color: #888; cursor: pointer; font-size: 12px; }
        .tab-item.active-tab { color: #00ff00; }
        .tab-item i { font-size: 24px; display: block; }

        /* Style cho n√∫t b·∫•m ƒë·∫πp h∆°n */
        button:active { transform: scale(0.98); opacity: 0.8; }
    </style>
</head>
<body>

    <div class="content-area">
        <div id="home" class="tab-content active">
            <div id="clock" style="font-size: 40px; text-align: center; margin-top: 20px; font-weight: bold;">00:00:00</div>
            <div id="weather" style="text-align: center; color: #aaa; margin-bottom: 20px;">H·ªì Ch√≠ Minh, VN</div>
            
            <div style="height: 300px; border-radius: 15px; overflow: hidden; border: 1px solid #333;">
                <iframe src="https://calendar.google.com/calendar/embed?src=tiendatphannguyen@gmail.com&ctz=Asia%2FHo_Chi_Minh&showTitle=0&showNav=0&showDate=1&showPrint=0&showTabs=0&showCalendars=0&mode=AGENDA" 
                        style="border: 0; width: 100%; height: 100%;" frameborder="0" scrolling="no"></iframe>
            </div>
        </div>

        <div id="control" class="tab-content">
            <h3 style="text-align: center; margin-bottom: 20px;">üí° ƒê√®n Neon B√†n H·ªçc</h3>
            
            <button onclick="initBluetooth()" id="connect-btn" style="width: 100%; padding: 15px; background: #008CBA; border: none; border-radius: 10px; color: white; font-size: 16px; font-weight: bold; cursor: pointer;">
                üîó K·∫æT N·ªêI BLUETOOTH
            </button>
            
            <p id="status" style="text-align: center; color: #ffd700; margin: 15px 0; font-size: 14px; min-height: 20px;">S·∫µn s√†ng k·∫øt n·ªëi...</p>
            
            <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                <button onclick="sendHex('ON')" style="width: 48%; padding: 20px; background: #4CAF50; border: none; border-radius: 10px; color: white; font-weight: bold; font-size: 18px;">B·∫¨T</button>
                <button onclick="sendHex('OFF')" style="width: 48%; padding: 20px; background: #f44336; border: none; border-radius: 10px; color: white; font-weight: bold; font-size: 18px;">T·∫ÆT</button>
            </div>

             <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                <button onclick="sendHex('STUDY')" style="background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 20px;">üìñ H·ªçc t·∫≠p</button>
                <button onclick="sendHex('RELAX')" style="background: #9C27B0; color: white; border: none; padding: 10px 20px; border-radius: 20px;">üéÆ Gi·∫£i tr√≠</button>
            </div>

            <div style="margin-top: 30px; background: #222; padding: 15px; border-radius: 15px; border: 1px solid #444;">
                <p style="margin: 0 0 10px 5px; color: #aaa; font-size: 12px;">üéµ Nh·∫°c Lo-fi / Gaming</p>
                <iframe width="100%" height="80" 
                        src="https://www.youtube.com/embed/videoseries?list=PLmP7O47PTy-McItNVWpEZxPTzqByUso82&si=tWm8Dz5hA25gRQ9X&autoplay=0&loop=1" 
                        title="YouTube Music Player" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                </iframe>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active-tab" onclick="switchTab('home', this)">
            <span style="font-size: 20px;">üè†</span><br>Home
        </div>
        <div class="tab-item" onclick="switchTab('control', this)">
            <span style="font-size: 20px;">‚öôÔ∏è</span><br>Control
        </div>
    </div>

    <script>
        /* --- 1. LOGIC GIAO DI·ªÜN --- */
        function switchTab(tabId, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active-tab'));
            document.getElementById(tabId).classList.add('active');
            el.classList.add('active-tab');
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('vi-VN');
        }
        setInterval(updateClock, 1000);
        updateClock(); // Ch·∫°y ngay l·∫≠p t·ª©c ƒë·ªÉ kh√¥ng b·ªã hi·ªán 00:00:00

        /* --- 2. LOGIC BLUETOOTH (ƒê√É CH√àN) --- */
        let lampCharacteristic = null;

        // C√°c UUID v√† M√£ Hex chu·∫©n
        const SERVICE_UUID = '0000fff0-0000-1000-8000-00805f9b34fb'; 
        const CHAR_UUID    = '0000fff3-0000-1000-8000-00805f9b34fb'; 

        const HEX_CODES = {
            'ON':    [0x7E, 0x04, 0x04, 0xF0, 0x00, 0x01, 0xFF, 0x00, 0xEF], 
            'OFF':   [0x7E, 0x04, 0x04, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xEF], 
            'STUDY': [0x7E, 0x05, 0x03, 0x00, 0xFF, 0x00], // L∆∞u √Ω: C√≥ th·ªÉ c·∫ßn d√≤ l·∫°i m√£ 9 byte n·∫øu m√£ 6 byte n√†y kh√¥ng ch·∫°y
            'RELAX': [0x7E, 0x05, 0x03, 0xFF, 0x00, 0xFF]  
        };

        async function initBluetooth() {
            const statusEl = document.getElementById('status');
            if (!statusEl) { console.error("Kh√¥ng t√¨m th·∫•y th·∫ª status!"); return; }

            try {
                statusEl.innerText = "ƒêang qu√©t t·∫•t c·∫£ thi·∫øt b·ªã...";
                statusEl.style.color = "yellow";
                
                // Qu√©t thi·∫øt b·ªã (ƒë√£ m·ªü r·ªông ph·∫°m vi acceptAllDevices)
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID.toLowerCase()] 
                });

                statusEl.innerText = "ƒêang k·∫øt n·ªëi v·ªõi: " + device.name + "...";
                const server = await device.gatt.connect();
                
                statusEl.innerText = "ƒêang t√¨m d·ªãch v·ª• ƒëi·ªÅu khi·ªÉn...";
                const service = await server.getPrimaryService(SERVICE_UUID.toLowerCase());
                lampCharacteristic = await service.getCharacteristic(CHAR_UUID.toLowerCase());

                statusEl.innerText = "‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!";
                statusEl.style.color = "#00ff00"; // M√†u xanh b√°o hi·ªáu th√†nh c√¥ng
                
                // T·ª± ƒë·ªông ng·∫Øt k·∫øt n·ªëi sau 10 ph√∫t ƒë·ªÉ ti·∫øt ki·ªám pin (t√πy ch·ªçn)
                device.addEventListener('gattserverdisconnected', onDisconnected);

            } catch (error) {
                statusEl.innerText = "‚ùå L·ªói: " + error.message;
                statusEl.style.color = "red";
                console.error(error);
            }
        }

        function onDisconnected(event) {
            const device = event.target;
            document.getElementById('status').innerText = "‚ö†Ô∏è ƒê√£ ng·∫Øt k·∫øt n·ªëi";
            document.getElementById('status').style.color = "orange";
            lampCharacteristic = null;
        }

        async function sendHex(mode) {
            const statusEl = document.getElementById('status');
            if (!lampCharacteristic) {
                statusEl.innerText = "‚ö†Ô∏è Ch∆∞a k·∫øt n·ªëi! H√£y b·∫•m n√∫t K·∫æT N·ªêI tr∆∞·ªõc.";
                statusEl.style.color = "orange";
                return;
            }

            const command = new Uint8Array(HEX_CODES[mode]);
            
            try {
                // ∆Øu ti√™n Write With Response (An to√†n)
                await lampCharacteristic.writeValueWithResponse(command);
                statusEl.innerText = "‚úÖ ƒê√£ g·ª≠i l·ªánh: " + mode;
                statusEl.style.color = "#00ff00";
            } catch (error) {
                console.warn("WriteWithResponse failed, trying WithoutResponse...");
                try {
                    // D·ª± ph√≤ng Write Without Response (Nhanh)
                    await lampCharacteristic.writeValueWithoutResponse(command);
                    statusEl.innerText = "‚úÖ ƒê√£ g·ª≠i (No-Resp): " + mode;
                    statusEl.style.color = "#00ff00";
                } catch (err2) {
                    statusEl.innerText = "‚ùå L·ªói g·ª≠i l·ªánh: " + err2.message;
                    statusEl.style.color = "red";
                }
            }
        }
    </script>
</body>
</html>
